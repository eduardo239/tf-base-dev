name: Terraform Force Unlock

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to unlock (dev/prod)"
        required: true
        type: choice
        options:
          - dev
          - prod
      lock_id:
        description: "Lock ID to force unlock (get from error message)"
        required: true
        type: string

env:
  TF_VERSION: "1.13.5"

jobs:
  force-unlock:
    name: Force Unlock Terraform State
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Google Auth
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init
        working-directory: terraform/environments/${{ inputs.environment }}
        run: terraform init

      - name: Validate Lock ID (prevent command injection)
        run: |
          LOCK_ID="${{ inputs.lock_id }}"
          # Terraform lock IDs are UUIDs: only a-fA-F, 0-9, hyphens; 36 chars
          if ! echo "$LOCK_ID" | grep -qE '^[a-fA-F0-9-]{36}$'; then
            echo "âŒ Invalid lock_id format. Must be a UUID (e.g. xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx)"
            exit 1
          fi
          echo "LOCK_ID=$LOCK_ID" >> $GITHUB_ENV

      - name: Force Unlock
        working-directory: terraform/environments/${{ inputs.environment }}
        env:
          LOCK_ID: ${{ env.LOCK_ID }}
        run: |
          echo "ğŸ”“ Force unlocking state with Lock ID: $LOCK_ID"
          terraform force-unlock -force "$LOCK_ID"
          echo "âœ… State unlocked successfully"

      - name: Verify State
        working-directory: terraform/environments/${{ inputs.environment }}
        run: |
          echo "ğŸ” Verifying state is accessible..."
          terraform plan -detailed-exitcode || echo "State is now accessible"
