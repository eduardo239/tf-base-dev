name: Terraform Infrastructure

on:
  push:
    branches:
      - main
      - dev
    paths:
      - "terraform/**/*.tf"
      - "terraform/**/*.tfvars"
      - "terraform/**/*.json"
      - ".github/workflows/terraform.yaml"
  pull_request:
    paths:
      - "terraform/**/*.tf"
      - "terraform/**/*.tfvars"
      - "terraform/**/*.json"
      - ".github/workflows/terraform.yaml"

env:
  TF_VERSION: "1.13.5"

jobs:
  terraform-plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    timeout-minutes: 30 # Set overall job timeout

    strategy:
      matrix:
        environment: [dev, prod]
      max-parallel: 1 # Prevent concurrent runs that could cause state locks
      fail-fast: false # Continue with other environments if one fails

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Verify Terraform Installation
        run: |
          terraform version
          which terraform

      - name: Google Auth
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Format Check
        run: |
          echo "Checking Terraform format across all directories..."
          if ! terraform fmt -check -recursive .; then
            echo "âŒ Terraform files are not formatted correctly!"
            echo "ðŸ’¡ Run 'make fmt' or 'terraform fmt -recursive .' to fix"
            exit 1
          fi
          echo "âœ… All Terraform files are properly formatted"

      - name: Terraform Init
        working-directory: terraform/environments/${{ matrix.environment }}
        run: terraform init -lock-timeout=10m
        continue-on-error: false

      - name: Terraform Validate
        working-directory: terraform/environments/${{ matrix.environment }}
        run: terraform validate

      - name: Security Pre-Check
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          echo "ðŸ” Running security pre-checks..."

          # Check for potential destructive changes in configuration
          if grep -r "force_destroy.*=.*true\|skip_final_snapshot.*=.*true" . 2>/dev/null; then
            echo "âš ï¸ Found potentially destructive configurations - review required"
          fi

          # Check for hardcoded secrets (basic check)
          if grep -r -i "password\|secret\|token\|key" --include="*.tf" --include="*.tfvars" . 2>/dev/null | grep -v "var\." | grep -v "data\." | grep -v "random_"; then
            echo "âš ï¸ Potential hardcoded secrets found - please review"
          fi

          echo "âœ… Security pre-check completed"

      - name: Terraform Plan with Retry
        working-directory: terraform/environments/${{ matrix.environment }}
        timeout-minutes: 20 # Set step timeout
        run: |
          # Function to check and clean stale locks
          cleanup_stale_locks() {
            echo "ðŸ” Checking for existing locks..."
            # Simple lock cleanup - check state and force unlock if needed
            if ! terraform plan -detailed-exitcode -refresh=false > /dev/null 2>&1; then
              echo "âš ï¸ State appears locked, attempting cleanup..."
              # Get any existing lock ID from error output
              lock_info=$(terraform plan 2>&1 | grep -o 'ID: [a-f0-9-]*' | head -1 | cut -d' ' -f2 || echo "")
              if [ ! -z "$lock_info" ]; then
                echo "ðŸ§¹ Attempting to remove lock: $lock_info"
                terraform force-unlock -force "$lock_info" || true
                sleep 3
              fi
            fi
          }

          # Function to attempt terraform plan with retries
          attempt_plan() {
            local max_attempts=3
            local attempt=1

            # Clean up any potential stale locks first
            cleanup_stale_locks

            while [ $attempt -le $max_attempts ]; do
              echo "Attempt $attempt of $max_attempts..."
              echo "Environment: ${{ matrix.environment }}"
              echo "Timestamp: $(date)"

              # Use a longer lock timeout and add refresh
              if terraform plan -out=tfplan -lock-timeout=10m -refresh=true -parallelism=4; then
                echo "âœ… Terraform plan successful"

                # Drift detection
                plan_exit_code=$?
                if [ $plan_exit_code -eq 2 ]; then
                  echo "âš ï¸ Infrastructure drift detected - changes are planned"
                elif [ $plan_exit_code -eq 0 ]; then
                  echo "âœ… No changes needed - infrastructure matches configuration"
                fi

                return 0
              else
                echo "âŒ Terraform plan failed on attempt $attempt"

                if [ $attempt -eq $max_attempts ]; then
                  echo "ðŸ” Final attempt to clean locks..."
                  cleanup_stale_locks
                  echo "ðŸ’¥ All attempts failed"
                  return 1
                fi

                echo "â³ Waiting 60 seconds before retry..."
                sleep 60

                # Clean up before retry
                cleanup_stale_locks

                ((attempt++))
              fi
            done
          }

          attempt_plan

      - name: Analyze Plan for Destructive Changes
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          echo "ðŸ” Analyzing plan for destructive changes..."

          # Check if plan file exists and analyze it
          if [ -f tfplan ]; then
            # Convert plan to JSON for analysis
            terraform show -json tfplan > plan.json

            # Check for destructive actions
            destructive_actions=$(jq -r '.resource_changes[]? | select(.change.actions[]? == "delete" or .change.actions[]? == "replace") | .address' plan.json 2>/dev/null || echo "")

            if [ ! -z "$destructive_actions" ]; then
              echo "âš ï¸ DESTRUCTIVE CHANGES DETECTED:"
              echo "$destructive_actions"
              echo ""
              echo "These resources will be deleted or replaced:"
              jq -r '.resource_changes[]? | select(.change.actions[]? == "delete" or .change.actions[]? == "replace") | "  - " + .address + " (" + (.change.actions | join(",")) + ")"' plan.json 2>/dev/null || echo "Could not parse detailed changes"

              # For production, we might want to fail here or require manual approval
              if [ "${{ matrix.environment }}" = "prod" ]; then
                echo ""
                echo "ðŸš¨ Production environment - manual review required for destructive changes"
              fi
            else
              echo "âœ… No destructive changes detected"
            fi

            # Clean up
            rm -f plan.json
          else
            echo "âš ï¸ No plan file found to analyze"
          fi

      - name: Upload Plan
        uses: actions/upload-artifact@v5.0.0
        with:
          name: tfplan-${{ matrix.environment }}
          path: terraform/environments/${{ matrix.environment }}/tfplan
          retention-days: 1

      - name: Cleanup on Failure
        if: always() # Run cleanup even on success to prevent stale locks
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          echo "ðŸ§¹ Post-execution cleanup..."

          # List any terraform processes
          echo "Active terraform processes:"
          ps aux | grep terraform | grep -v grep || echo "No terraform processes found"

          # Simple cleanup - try to unlock if state is locked
          echo "Checking for locks to clean up..."
          if ! terraform plan -detailed-exitcode -refresh=false > /dev/null 2>&1; then
            echo "State appears locked, attempting cleanup..."
            lock_info=$(terraform plan 2>&1 | grep -o 'ID: [a-f0-9-]*' | head -1 | cut -d' ' -f2 || echo "")
            if [ ! -z "$lock_info" ]; then
              echo "Found lock to clean: $lock_info"
              terraform force-unlock -force "$lock_info" 2>/dev/null || true
            fi
          fi

          # Clean up temporary files
          rm -f plan.json tfplan 2>/dev/null || true

          echo "âœ… Cleanup completed"

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: terraform-plan
    timeout-minutes: 45 # Set overall job timeout

    strategy:
      matrix:
        environment: [dev, prod]
      max-parallel: 1 # Deploy one environment at a time
      fail-fast: false

    # Conditional execution based on branch and environment
    if: |
      (github.ref == 'refs/heads/dev' && github.event_name == 'push') ||
      (github.ref == 'refs/heads/main' && github.event_name == 'push')

    environment:
      name: ${{ matrix.environment }}
      # Add protection for production
      url: ${{ matrix.environment == 'prod' && 'https://console.cloud.google.com' || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: ${{ env.TF_VERSION }}
          terraform_wrapper: false

      - name: Verify Terraform Installation
        run: |
          terraform version
          which terraform

      - name: Google Auth
        uses: google-github-actions/auth@v3
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Terraform Init
        working-directory: terraform/environments/${{ matrix.environment }}
        run: terraform init -lock-timeout=10m

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: tfplan-${{ matrix.environment }}
          path: terraform/environments/${{ matrix.environment }}

      - name: Environment-specific Deploy Gate
        run: |
          echo "ðŸŽ¯ Deploying to: ${{ matrix.environment }}"
          echo "ðŸ“… Branch: ${{ github.ref }}"
          echo "ðŸ”„ Event: ${{ github.event_name }}"

          # Skip if wrong environment for branch
          if [[ "${{ github.ref }}" == "refs/heads/dev" && "${{ matrix.environment }}" != "dev" ]]; then
            echo "â­ï¸ Skipping ${{ matrix.environment }} deployment from dev branch"
            exit 0
          fi

          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ matrix.environment }}" != "prod" ]]; then
            echo "â­ï¸ Skipping ${{ matrix.environment }} deployment from main branch"
            exit 0
          fi

          echo "âœ… Proceeding with deployment to ${{ matrix.environment }}"

      - name: Pre-Apply Security Check
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          echo "ðŸ” Final security check before apply..."

          if [ -f tfplan ]; then
            # Convert plan to JSON and check for sensitive changes
            terraform show -json tfplan > plan.json

            # Check for IAM changes
            iam_changes=$(jq -r '.resource_changes[]? | select(.type | contains("iam")) | .address' plan.json 2>/dev/null || echo "")
            if [ ! -z "$iam_changes" ]; then
              echo "âš ï¸ IAM changes detected:"
              echo "$iam_changes"
            fi

            # Check for network changes
            network_changes=$(jq -r '.resource_changes[]? | select(.type | contains("network") or contains("firewall") or contains("vpc")) | .address' plan.json 2>/dev/null || echo "")
            if [ ! -z "$network_changes" ]; then
              echo "âš ï¸ Network changes detected:"
              echo "$network_changes"
            fi

            rm -f plan.json
          fi

          echo "âœ… Security check completed"

      - name: Terraform Apply with Lock Handling
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          # Skip if wrong environment for branch
          if [[ "${{ github.ref }}" == "refs/heads/dev" && "${{ matrix.environment }}" != "dev" ]]; then
            echo "â­ï¸ Skipping apply for ${{ matrix.environment }}"
            exit 0
          fi

          if [[ "${{ github.ref }}" == "refs/heads/main" && "${{ matrix.environment }}" != "prod" ]]; then
            echo "â­ï¸ Skipping apply for ${{ matrix.environment }}"
            exit 0
          fi

          echo "ðŸš€ Applying changes to ${{ matrix.environment }}..."

          # Apply with extended lock timeout
          terraform apply -auto-approve -lock-timeout=15m tfplan

          echo "âœ… Apply completed successfully"

      - name: Post-Apply Verification
        if: success()
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          echo "ðŸ” Verifying deployment..."

          # Basic state verification
          terraform show > /dev/null 2>&1
          if [ $? -eq 0 ]; then
            echo "âœ… Terraform state is accessible"
          else
            echo "âš ï¸ Issues accessing Terraform state"
          fi

          # Output key information
          echo "ðŸ“‹ Deployment summary:"
          echo "Environment: ${{ matrix.environment }}"
          echo "Timestamp: $(date)"
          echo "Commit: ${{ github.sha }}"

      - name: Cleanup on Failure
        if: failure()
        working-directory: terraform/environments/${{ matrix.environment }}
        run: |
          echo "ðŸ§¹ Cleaning up after failure..."

          # Try to unlock state if locked
          if ! terraform plan -detailed-exitcode -refresh=false > /dev/null 2>&1; then
            echo "State appears locked, attempting cleanup..."
            lock_info=$(terraform plan 2>&1 | grep -o 'ID: [a-f0-9-]*' | head -1 | cut -d' ' -f2 || echo "")
            if [ ! -z "$lock_info" ]; then
              echo "Cleaning up lock: $lock_info"
              terraform force-unlock -force "$lock_info" 2>/dev/null || true
            fi
          fi

          echo "âœ… Cleanup completed"
